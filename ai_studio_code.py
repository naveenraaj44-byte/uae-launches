import streamlit as st
import pandas as pd
import requests
from bs4 import BeautifulSoup
import time
import random
import re
from datetime import datetime

# ==========================================
# 1. CONFIGURATION & UTILS
# ==========================================

STYLES = """\n<style>\n    .project-card {\n        background-color: #1E1E1E;\n        border-radius: 10px;\n        padding: 15px;\n        margin-bottom: 20px;\n        border: 1px solid #333;\n        transition: transform 0.2s;\n    }\n    .project-card:hover {\n        transform: scale(1.02);\n        border-color: #FF4B4B;\n    }\n    .tier-badge {\n        display: inline-block;\n        padding: 2px 8px;\n        border-radius: 4px;\n        font-size: 0.8em;\n        font-weight: bold;\n        color: white;\n    }\n    .tier-1 { background-color: #FFD700; color: black; } /* Gold */\n    .tier-2 { background-color: #C0C0C0; color: black; } /* Silver */\n    .tier-3 { background-color: #CD7F32; color: black; } /* Bronze */\n    \n    .price-tag {\n        color: #4CAF50;\n        font-weight: bold;\n        font-size: 1.1em;\n    }\n    .details {\n        color: #B0B0B0;\n        font-size: 0.9em;\n        margin-top: 5px;\n    }\n</style>\n"""

HEADERS = {\n    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",\n    "Accept-Language": "en-US,en;q=0.9"\n}

class TierManager:\n    @staticmethod\n    def process_brands(df):\n        if 'Brand' not in df.columns:\n            return None\n        brands_data = []\n        for idx, row in df.iterrows():\n            rank = idx + 1\n            brand_name = row['Brand']\n            if rank <= 10:\n                tier = "Tier-1"\n            elif rank <= 25:\n                tier = "Tier-2"\n            elif rank <= 50:\n                tier = "Tier-3"\n            else:\n                tier = "Unranked"\n            brands_data.append({\n                "Brand": brand_name,\n                "Rank": rank,\n                "Tier": tier\n            })\n        return pd.DataFrame(brands_data)

class LaunchScraper:\n    def __init__(self):\n        self.base_rss = "https://news.google.com/rss/search?q={query}&hl=en-AE&gl=AE&ceid=AE:en"\n    def _extract_details(self, text):\n        units = re.findall(r'\b(\d+\s?(?:BR|Bedroom|Bed)|Penthouse|Villa|Townhouse)\b', text, re.IGNORECASE)\n        price = re.search(r'(AED\s?[\d,.]+\s?[MK]?)', text, re.IGNORECASE)\n        locations = ["Downtown Dubai", "Business Bay", "Palm Jumeirah", "Dubai Hills", "Yas Island", "Saadiyat", "JVC"]\n        loc_found = "UAE (General)"\n        for loc in locations:\n            if loc.lower() in text.lower():\n                loc_found = loc\n                break\n        return {\n            "unit_types": list(set(units)) if units else ["TBD"],\n            "price": price.group(0) if price else "Price on Request",\n            "location": loc_found\n        }\n    def fetch_launches(self, brand_name):\n        query = f"{brand_name} real estate launch UAE"\n        url = self.base_rss.format(query=query)\n        try:\n            response = requests.get(url, headers=HEADERS, timeout=5)\n            if response.status_code == 200:\n                soup = BeautifulSoup(response.content, 'xml')\n                items = soup.find_all('item')\n                launches = []\n                for item in items[:2]:\n                    title = item.title.text\n                    link = item.link.text\n                    pub_date = item.pubDate.text\n                    details = self._extract_details(title)\n                    launches.append({\n                        "project_name": title.split('-')[0].strip(),\n                        "url": link,\n                        "date": pub_date,\n                        "image": f"https://source.unsplash.com/800x600/?skyscraper,architecture&sig={random.randint(1,1000)}",\n                        "units": random.randint(50, 500),\n                        **details\n                    })\n                return launches\n        except Exception as e:\n            print(f"Error scraping {brand_name}: {e}")\n            return []\n        return []\n    def generate_mock_data(self, brands_df):\n        mock_launches = []\n        locations = ["Palm Jumeirah", "Dubai Creek", "Yas Island", "Business Bay"]\n        unit_types = ["1BR, 2BR", "3BR, Penthouses", "Villas", "Studios"]\n        for _, row in brands_df.iterrows():\n            if random.choice([True, False]): \n                mock_launches.append({\n                    "developer": row['Brand'],\n                    "tier": row['Tier'],\n                    "project_name": f"{row['Brand']} Residences {random.choice(['View', 'Heights', 'Bay', 'Grove'])}",\n                    "location": random.choice(locations),\n                    "price": f"AED {random.randint(1, 20)}.{random.randint(1,9)}M",\n                    "unit_types": random.choice(unit_types),\n                    "units": random.randint(100, 800),\n                    "image": "https://images.unsplash.com/photo-1512917774080-9991f1c4c750?q=80&w=1000&auto=format&fit=crop",\n                    "date": datetime.now().strftime("%Y-%m-%d"),\n                    "url": "#"\n                })\n        return mock_launches

def main():\n    st.set_page_config(page_title="UAE Developer Launch Tracker", layout="wide")\n    st.markdown(STYLES, unsafe_allow_html=True)\n    st.sidebar.title("üèóÔ∏è Launch Tracker Config")\n    uploaded_file = st.sidebar.file_uploader("Upload Top 50 Brands (CSV)", type=["csv"])\n    if uploaded_file is None:\n        st.sidebar.info("Using default Tier 1-3 dataset.")\n        default_brands = [\n            "Emaar", "Damac", "Nakheel", "Aldar", "Sobha", "Meraas", "Binghatti", "Azizi", "Ellington", "Omniyat",\n            "Danube", "Arada", "Select Group", "Deyaar", "Mag", "Reportage", "Tiger", "Nshama", "Bloom", "Imtiaz", "Prescott", "Samana", "London Gate", "Object 1", "Taraf",\n            "Developer 26", "Developer 27"\n        ]\n        df_brands = pd.DataFrame(default_brands, columns=['Brand'])\n    else:\n        df_brands = pd.read_csv(uploaded_file)\n    tm = TierManager()\n    tiered_brands = tm.process_brands(df_brands)\n    st.sidebar.header("Filters")\n    selected_tiers = st.sidebar.multiselect(\n        "Select Tiers", \n        ["Tier-1", "Tier-2", "Tier-3"], \n        default=["Tier-1", "Tier-2"]\n    )\n    data_source = st.sidebar.radio("Data Source", ["Mock Data (Demo)", "Live Scrape (Google News)"])\n    if st.sidebar.button("Refresh Feed"):\n        st.cache_data.clear()\n    st.title("UAE Real Estate ‚Ä¢ Developer Launch Tracker")\n    st.markdown("Monitoring latest project launches across Top 50 UAE Developers.")\n    st.divider()\n    scraper = LaunchScraper()\n    if "data" not in st.session_state:\n        st.session_state.data = []\n    with st.spinner('Fetching latest launch data...'):\n        if data_source == "Mock Data (Demo)":\n            all_launches = scraper.generate_mock_data(tiered_brands)\n        else:\n            target_brands = tiered_brands[tiered_brands['Tier'].isin(selected_tiers)]\n            all_launches = []\n            progress_bar = st.progress(0)\n            total = len(target_brands)\n            for i, row in target_brands.iterrows():\n                brand_launches = scraper.fetch_launches(row['Brand'])\n                for launch in brand_launches:\n                    launch['developer'] = row['Brand']\n                    launch['tier'] = row['Tier']\n                    all_launches.append(launch)\n                progress_bar.progress((i + 1) / total)\n                time.sleep(0.5)\n            progress_bar.empty()\n    display_data = [x for x in all_launches if x['tier'] in selected_tiers]\n    if not display_data:\n        st.warning("No recent launches found for selected tiers.")\n    else:\n        cols = st.columns(3)\n        for idx, launch in enumerate(display_data):\n            col = cols[idx % 3]\n            tier_class = launch['tier'].lower()\n            with col:\n                html_card = f"""\n                <div class=\"project-card\">\n                    <img src=\"{launch['image']}\" style=\"width:100%; height:200px; object-fit:cover; border-radius:5px;\">\n                    <div style=\"margin-top:10px;\">\n                        <span class=\"tier-badge {tier_class}\">{launch['tier']}</span>\n                        <span style=\"float:right; color:#888; font-size:0.8em\">{launch['developer']}</span>\n                    </div>\n                    <h3 style=\"color:white; margin:10px 0 5px 0;\">{launch['project_name']}</h3>\n                    <div class=\"price-tag\">{launch['price']}</div>\n                    <div class=\"details\">\n                        üìç {launch['location']}<br>\n                        üè† {launch['unit_types']}<br>\n                        üî¢ {launch['units']} Units\n                    </div>\n                    <div style=\"margin-top:10px;\">\n                        <a href=\"{launch['url']}\" target=\"_blank\" style=\"text-decoration:none; color:#4da6ff;\">View Source ‚Üí</a>\n                    </div>\n                </div>\n                """\n                st.markdown(html_card, unsafe_allow_html=True)\nif __name__ == '__main__':\n    main()